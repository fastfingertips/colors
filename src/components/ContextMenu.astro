---
---

<div id="context-menu" class="context-menu">
  <div class="menu-header">
    <div class="menu-color-preview"></div>
    <div class="menu-info">
      <span class="menu-color-name">Color Name</span>
      <span class="menu-color-hex">#000000</span>
    </div>
  </div>
  <div class="menu-separator"></div>
  <button data-format="hex">
    <span>HEX</span>
    <span class="value-preview">#000000</span>
  </button>
  <button data-format="rgb">
    <span>RGB</span>
    <span class="value-preview">rgb(0,0,0)</span>
  </button>
  <button data-format="hsl">
    <span>HSL</span>
    <span class="value-preview">hsl(0,0%,0%)</span>
  </button>
  <div class="menu-separator"></div>
  <button data-format="css">Copy CSS Variable</button>
  <div class="menu-separator"></div>
  <button data-action="view-details" class="view-details-btn">
    <span>View Shades & Tints</span>
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
      <polyline points="15 3 21 3 21 9"></polyline>
      <line x1="10" y1="14" x2="21" y2="3"></line>
    </svg>
  </button>
</div>

<script>
  import { hexToRgb, hexToHsl } from '../utils/colorUtils';

  const contextMenu = document.getElementById('context-menu') as HTMLElement;
  const menuPreviewColor = contextMenu?.querySelector('.menu-color-preview') as HTMLElement;
  const menuColorName = contextMenu?.querySelector('.menu-color-name') as HTMLElement;
  const menuColorHex = contextMenu?.querySelector('.menu-color-hex') as HTMLElement;
  const menuHexVal = contextMenu?.querySelector('button[data-format="hex"] .value-preview') as HTMLElement;
  const menuRgbVal = contextMenu?.querySelector('button[data-format="rgb"] .value-preview') as HTMLElement;
  const menuHslVal = contextMenu?.querySelector('button[data-format="hsl"] .value-preview') as HTMLElement;

  let lastRightClickedColor: string = '';
  let lastRightClickedElement: HTMLElement | null = null;



  if (contextMenu) {
    document.addEventListener('contextmenu', (e) => {
      const target = e.target as HTMLElement;
      const colorBox = target.closest('.color-box, .color-card') as HTMLElement;

      if (colorBox) {
        e.preventDefault();
        const hex = colorBox.getAttribute('data-hex') || '';
        const name = colorBox.querySelector('.color-name')?.textContent || 'Color';

        if (!hex) return;

        lastRightClickedColor = hex;
        lastRightClickedElement = colorBox;

        if (menuPreviewColor) menuPreviewColor.style.backgroundColor = hex;
        if (menuColorName) menuColorName.textContent = name;
        if (menuColorHex) menuColorHex.textContent = hex;

        if (menuHexVal) menuHexVal.textContent = hex;
        if (menuRgbVal) menuRgbVal.textContent = hexToRgb(hex);
        if (menuHslVal) menuHslVal.textContent = hexToHsl(hex).replace(/\s+/g, '');

        const { clientX: mouseX, clientY: mouseY } = e;
        
        const menuWidth = 200; 
        const menuHeight = 250; 
        let top = mouseY;
        let left = mouseX;

        if (left + menuWidth > window.innerWidth) left = window.innerWidth - menuWidth - 20;
        if (top + menuHeight > window.innerHeight) top = window.innerHeight - menuHeight - 20;

        contextMenu.style.top = `${top}px`;
        contextMenu.style.left = `${left}px`;
        contextMenu.classList.add('open');
      } else {
        contextMenu.classList.remove('open');
      }
    });

    document.addEventListener('click', () => {
      if (contextMenu.classList.contains('open')) {
        contextMenu.classList.remove('open');
      }
    });

    contextMenu.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('button');
      if (!btn || !lastRightClickedColor) return;

      const format = btn.getAttribute('data-format');
      const action = btn.getAttribute('data-action');

      if (action === 'view-details') {
        const pureHex = lastRightClickedColor.substring(1);
        window.location.href = `/color/${pureHex}`;
        return;
      }

      let textToCopy = lastRightClickedColor;

      if (format === 'rgb') {
        textToCopy = hexToRgb(lastRightClickedColor);
      } else if (format === 'hsl') {
        textToCopy = hexToHsl(lastRightClickedColor);
      } else if (format === 'css') {
        textToCopy = `var(--color-${lastRightClickedColor.substring(1)})`;
      }

      navigator.clipboard.writeText(textToCopy).then(() => {
        const event = new CustomEvent('color-copied', {
          detail: {
            color: lastRightClickedColor,
            element: lastRightClickedElement,
            message: `Copied ${format?.toUpperCase()}!`
          }
        });
        document.dispatchEvent(event);
      });
    });
  }
</script>
