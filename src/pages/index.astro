---
import Layout from '../layouts/Layout.astro';
import ScrollToTop from '../components/ScrollToTop.astro';
import FilterMenu from '../components/FilterMenu.astro';
import GridControls from '../components/GridControls.astro';
---

<Layout title="Colors">
	<main>
		<div class="header">
			<h1>Colors</h1>
		</div>

		<div class="controls-container">
			<FilterMenu />
			<span id="color-count">...</span>
			<GridControls />
		</div>

		<div id="color-container" class="color-container"></div>

		<footer>
			<p>Data source: <a href="https://gist.githubusercontent.com/Lenochxd/12a1927943a2ce151560e1b9585d4bfa/raw/41d5a0dc9336827cefb217c1728f0e9415b1c7b9/colors_db.json" target="_blank">colors_db.json</a></p>
			<p>Dedicated to <a href="https://github.com/Lenochxd" target="_blank">Lenoch</a></p>
		</footer>

		<div id="copy-message" class="copy-message">Copied to clipboard!</div>
		
		<ScrollToTop />
	</main>
</Layout>

<script>
	let colors: any[] = [];
	let lastCopiedColorIndex: number | null = null;

	const container = document.getElementById('color-container') as HTMLElement;
	const colorCount = document.getElementById('color-count') as HTMLElement;
	const allBtn = document.getElementById('all-button') as HTMLButtonElement;
	const darkBtn = document.getElementById('dark-button') as HTMLButtonElement;
	const lightBtn = document.getElementById('light-button') as HTMLButtonElement;
	const copyMsg = document.getElementById('copy-message') as HTMLElement;
	const indicator = document.getElementById('menu-indicator') as HTMLElement;

	fetch('https://gist.githubusercontent.com/Lenochxd/12a1927943a2ce151560e1b9585d4bfa/raw/41d5a0dc9336827cefb217c1728f0e9415b1c7b9/colors_db.json')
		.then(response => response.json())
		.then(data => {
			colors = data;
			displayColors(colors);
			colorCount.innerText = `${colors.length} colors available`;
			moveIndicator(indicator, allBtn);
		})
		.catch(error => {
			console.error('Error fetching the colors:', error);
			colorCount.innerText = 'Error loading colors';
		});

	function isDarkColor(hex: string) {
		const rgb = parseInt(hex.slice(1), 16);
		const r = (rgb >> 16) & 0xff;
		const g = (rgb >> 8) & 0xff;
		const b = (rgb >> 0) & 0xff;
		const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
		return luminance < 128;
	}

	function displayColors(colorArray: any[]) {
		if (!container) return;
		container.innerHTML = '';
		
		const staggerDelay = colorArray.length > 100 ? 5 : 15;

		colorArray.forEach((color, index) => {
			const colorBox = document.createElement('div');
			colorBox.className = 'color-box';
			colorBox.style.backgroundColor = color.hex_code;
			colorBox.style.animationDelay = `${index * staggerDelay}ms`;

			const textColor = isDarkColor(color.hex_code) ? '#ffffff' : '#000000';
			colorBox.style.color = textColor;

			colorBox.innerHTML = `
				<span>${color.name}</span>
				<div class="tooltip">${color.hex_code}</div>
			`;

			colorBox.onclick = () => {
				navigator.clipboard.writeText(color.hex_code).then(() => {
					showCopyMessage();
					highlightColorBox(colorBox);
					updateFavicon(color.hex_code);
				}).catch(err => {
					console.error('Failed to copy color code: ', err);
				});
			};
			container.appendChild(colorBox);
		});
	}

	function moveIndicator(targetIndicator: HTMLElement | null, btn: HTMLElement | null) {
		if (!targetIndicator || !btn) return;
		targetIndicator.style.width = `${btn.offsetWidth}px`;
		targetIndicator.style.transform = `translateX(${btn.offsetLeft - 2}px)`;
	}

	async function filterColors(type: 'all' | 'dark' | 'light') {
		if (!container) return;

		container.classList.add('filtering');
		await new Promise(resolve => setTimeout(resolve, 300));

		let filteredColors: any[];
		if (type === 'dark') {
			filteredColors = colors.filter(color => isDarkColor(color.hex_code));
		} else if (type === 'light') {
			filteredColors = colors.filter(color => !isDarkColor(color.hex_code));
		} else {
			filteredColors = colors;
		}
		
		displayColors(filteredColors);
		if (colorCount) colorCount.innerText = `${filteredColors.length} colors available`;

		container.classList.remove('filtering');

		const activeBtn = document.getElementById(`${type}-button`) as HTMLButtonElement;
		[allBtn, darkBtn, lightBtn].forEach(btn => btn.classList.remove('active'));
		if (activeBtn) {
			activeBtn.classList.add('active');
			moveIndicator(indicator, activeBtn);
		}
	}

	function highlightColorBox(box: HTMLElement) {
		document.querySelectorAll('.color-box').forEach(b => b.classList.remove('rounded'));
		box.classList.add('rounded');
	}

	function showCopyMessage() {
		if (copyMsg) copyMsg.classList.add('show');
		setTimeout(() => {
			if (copyMsg) copyMsg.classList.remove('show');
		}, 2500);
	}

	function updateFavicon(color: string) {
		const canvas = document.createElement('canvas');
		canvas.width = 32;
		canvas.height = 32;
		const ctx = canvas.getContext('2d');
		if (!ctx) return;
		
		ctx.fillStyle = color;
		ctx.fillRect(0, 0, canvas.width, canvas.height);

		const favicon = (document.querySelector('link[rel="icon"]') as HTMLLinkElement) || document.createElement('link');
		favicon.rel = 'icon';
		favicon.href = canvas.toDataURL('image/png');
		if (!document.querySelector('link[rel="icon"]')) {
			document.head.appendChild(favicon);
		}
	}

	const gridCompact = document.getElementById('grid-compact') as HTMLButtonElement;
	const gridComfortable = document.getElementById('grid-comfortable') as HTMLButtonElement;
	const gridLarge = document.getElementById('grid-large') as HTMLButtonElement;
	const gridIndicator = document.getElementById('grid-indicator') as HTMLElement;

	async function setGridSize(size: 'compact' | 'comfortable' | 'large') {
		if (!container) return;
		
		container.classList.add('filtering');
		await new Promise(resolve => setTimeout(resolve, 300));

		container.classList.remove('compact', 'large');
		if (size !== 'comfortable') {
			container.classList.add(size);
		}

		const currentFilter = (document.querySelector('.menu button.active') as HTMLElement)?.id.split('-')[0] as 'all' | 'dark' | 'light';
		
		let filteredColors: any[];
		if (currentFilter === 'dark') {
			filteredColors = colors.filter(color => isDarkColor(color.hex_code));
		} else if (currentFilter === 'light') {
			filteredColors = colors.filter(color => !isDarkColor(color.hex_code));
		} else {
			filteredColors = colors;
		}
		
		displayColors(filteredColors);

		const activeBtn = document.getElementById(`grid-${size}`) as HTMLButtonElement;
		[gridCompact, gridComfortable, gridLarge].forEach(btn => btn?.classList.remove('active'));
		if (activeBtn) {
			activeBtn.classList.add('active');
			moveIndicator(gridIndicator, activeBtn);
		}

		container.classList.remove('filtering');
	}

	window.addEventListener('load', () => {
		const initIndicators = () => {
			moveIndicator(indicator, allBtn);
			moveIndicator(gridIndicator, gridComfortable);
		};
		initIndicators();
		document.fonts.ready.then(initIndicators);
		setTimeout(initIndicators, 100);
	});

	window.addEventListener('resize', () => {
		const activeMenuBtn = document.querySelector('.menu button.active') as HTMLElement;
		const activeGridBtn = document.querySelector('.grid-controls button.active') as HTMLElement;
		moveIndicator(indicator, activeMenuBtn);
		moveIndicator(gridIndicator, activeGridBtn);
	});

	gridCompact?.addEventListener('click', () => setGridSize('compact'));
	gridComfortable?.addEventListener('click', () => setGridSize('comfortable'));
	gridLarge?.addEventListener('click', () => setGridSize('large'));

	allBtn?.addEventListener('click', () => filterColors('all'));
	darkBtn?.addEventListener('click', () => filterColors('dark'));
	lightBtn?.addEventListener('click', () => filterColors('light'));
</script>
