---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Colors">
	<main>
		<div class="header">
			<h1>Colors</h1>
			<div class="menu">
				<div id="menu-indicator" class="menu-indicator"></div>
				<button id="all-button" class="active">All</button>
				<button id="dark-button">Dark</button>
				<button id="light-button">Light</button>
			</div>
			<div class="info">
				<span id="color-count">Loading colors...</span> | Data source: <a href="https://gist.githubusercontent.com/Lenochxd/12a1927943a2ce151560e1b9585d4bfa/raw/41d5a0dc9336827cefb217c1728f0e9415b1c7b9/colors_db.json" target="_blank">colors_db.json</a>
			</div>
		</div>

		<div id="color-container" class="color-container"></div>

		<footer>
			<p>Dedicated to <a href="https://github.com/Lenochxd" target="_blank">Lenoch</a></p>
		</footer>

		<div id="copy-message" class="copy-message">Copied to clipboard!</div>
	</main>
</Layout>

<script>
	let colors: any[] = [];
	let lastCopiedColorIndex: number | null = null;

	const container = document.getElementById('color-container') as HTMLElement;
	const colorCount = document.getElementById('color-count') as HTMLElement;
	const allBtn = document.getElementById('all-button') as HTMLButtonElement;
	const darkBtn = document.getElementById('dark-button') as HTMLButtonElement;
	const lightBtn = document.getElementById('light-button') as HTMLButtonElement;
	const copyMsg = document.getElementById('copy-message') as HTMLElement;
	const indicator = document.getElementById('menu-indicator') as HTMLElement;

	// Initial fetch
	fetch('https://gist.githubusercontent.com/Lenochxd/12a1927943a2ce151560e1b9585d4bfa/raw/41d5a0dc9336827cefb217c1728f0e9415b1c7b9/colors_db.json')
		.then(response => response.json())
		.then(data => {
			colors = data;
			displayColors(colors);
			colorCount.innerText = `${colors.length} colors available`;
			updateIndicator(allBtn);
		})
		.catch(error => {
			console.error('Error fetching the colors:', error);
			colorCount.innerText = 'Error loading colors';
		});

	function isDarkColor(hex: string) {
		const rgb = parseInt(hex.slice(1), 16);
		const r = (rgb >> 16) & 0xff;
		const g = (rgb >> 8) & 0xff;
		const b = (rgb >> 0) & 0xff;
		const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b;
		return luminance < 128;
	}

	function displayColors(colorArray: any[]) {
		if (!container) return;
		container.innerHTML = '';
		
		// Reduce stagger for large arrays to maintain performance
		const staggerDelay = colorArray.length > 100 ? 5 : 15;

		colorArray.forEach((color, index) => {
			const colorBox = document.createElement('div');
			colorBox.className = 'color-box';
			colorBox.style.backgroundColor = color.hex_code;
			colorBox.style.animationDelay = `${index * staggerDelay}ms`;

			const textColor = isDarkColor(color.hex_code) ? '#ffffff' : '#000000';
			colorBox.style.color = textColor;

			colorBox.innerHTML = `
				<span>${color.name}</span>
				<div class="tooltip">${color.hex_code}</div>
			`;

			colorBox.onclick = () => {
				navigator.clipboard.writeText(color.hex_code).then(() => {
					showCopyMessage();
					highlightColorBox(colorBox);
					updateFavicon(color.hex_code);
				}).catch(err => {
					console.error('Failed to copy color code: ', err);
				});
			};
			container.appendChild(colorBox);
		});
	}

	function updateIndicator(btn: HTMLElement | null) {
		if (!indicator || !btn) return;
		indicator.style.width = `${btn.offsetWidth}px`;
		indicator.style.transform = `translateX(${btn.offsetLeft - 6}px)`;
	}

	async function filterColors(type: 'all' | 'dark' | 'light') {
		if (!container) return;

		// Start fade out
		container.classList.add('filtering');
		
		// Wait for fade out
		await new Promise(resolve => setTimeout(resolve, 300));

		let filteredColors: any[];
		if (type === 'dark') {
			filteredColors = colors.filter(color => isDarkColor(color.hex_code));
		} else if (type === 'light') {
			filteredColors = colors.filter(color => !isDarkColor(color.hex_code));
		} else {
			filteredColors = colors;
		}
		
		displayColors(filteredColors);
		if (colorCount) colorCount.innerText = `${filteredColors.length} colors available`;

		// End fade out
		container.classList.remove('filtering');

		// Update active button
		const activeBtn = document.getElementById(`${type}-button`) as HTMLButtonElement;
		[allBtn, darkBtn, lightBtn].forEach(btn => btn.classList.remove('active'));
		if (activeBtn) {
			activeBtn.classList.add('active');
			updateIndicator(activeBtn);
		}
	}

	function highlightColorBox(box: HTMLElement) {
		document.querySelectorAll('.color-box').forEach(b => b.classList.remove('rounded'));
		box.classList.add('rounded');
	}

	function showCopyMessage() {
		if (copyMsg) copyMsg.classList.add('show');
		setTimeout(() => {
			if (copyMsg) copyMsg.classList.remove('show');
		}, 2500);
	}

	function updateFavicon(color: string) {
		const canvas = document.createElement('canvas');
		canvas.width = 32;
		canvas.height = 32;
		const ctx = canvas.getContext('2d');
		if (!ctx) return;
		
		ctx.fillStyle = color;
		ctx.fillRect(0, 0, canvas.width, canvas.height);

		const favicon = (document.querySelector('link[rel="icon"]') as HTMLLinkElement) || document.createElement('link');
		favicon.rel = 'icon';
		favicon.href = canvas.toDataURL('image/png');
		if (!document.querySelector('link[rel="icon"]')) {
			document.head.appendChild(favicon);
		}
	}

	// Update indicator on resize
	window.addEventListener('resize', () => {
		const activeBtn = document.querySelector('.menu button.active');
		updateIndicator(activeBtn);
	});

	// Event Listeners
	allBtn?.addEventListener('click', () => filterColors('all'));
	darkBtn?.addEventListener('click', () => filterColors('dark'));
	lightBtn?.addEventListener('click', () => filterColors('light'));
</script>
