---
import Layout from '../layouts/Layout.astro';
import ScrollToTop from '../components/ScrollToTop.astro';
import FilterMenu from '../components/FilterMenu.astro';
import Footer from '../components/Footer.astro';
import GridControls from '../components/GridControls.astro';
---

<Layout title="Colors">
	<main>
		<div class="header">
			<h1>Colors</h1>
			<div class="header-desc">
				<span class="desc-item">
					<span class="key-badge icon" title="Left Click">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="6" y="2" width="12" height="20" rx="4"></rect>
							<line x1="12" y1="2" x2="12" y2="10"></line>
							<line x1="6" y1="10" x2="18" y2="10"></line>
							<path d="M6 6a4 4 0 0 1 4-4h2v8H6V6z" fill="currentColor"></path>
						</svg>
					</span> 
					<span class="action-text">to copy</span>
				</span>
				<span class="desc-separator">&middot;</span>
				<span class="desc-item">
					<span class="key-badge icon" title="Right Click">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="6" y="2" width="12" height="20" rx="4"></rect>
							<line x1="12" y1="2" x2="12" y2="10"></line>
							<line x1="6" y1="10" x2="18" y2="10"></line>
							<path d="M12 2h2a4 4 0 0 1 4 4v4h-6V2z" fill="currentColor"></path>
						</svg>
					</span> 
					<span class="action-text">for menu</span>
				</span>
				<span class="desc-separator">&middot;</span>
				<span class="desc-item">
					<span class="key-badge icon" title="Spacebar">
						<svg width="24" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 5H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"></path>
							<path d="M8 11h8" stroke-width="2"></path>
							<path d="M20 9v2" stroke-width="1"></path>
							<path d="M4 9v2" stroke-width="1"></path>
						</svg>
					</span> 
					<span class="action-text">toggle view</span>
				</span>
			</div>
		</div>

		<div class="controls-container">
			<FilterMenu />
			<span id="color-count">...</span>
			<GridControls />
		</div>

		<div id="color-container" class="color-container show-info no-gap"></div>

		<Footer />
		
		<ScrollToTop />
	</main>
</Layout>

<script>
	import { isDarkColor } from '../utils/colorUtils';

	let colors: any[] = [];
	const container = document.getElementById('color-container') as HTMLElement;
	const colorCount = document.getElementById('color-count') as HTMLElement;
	const allBtn = document.getElementById('all-button') as HTMLButtonElement;
	const darkBtn = document.getElementById('dark-button') as HTMLButtonElement;
	const lightBtn = document.getElementById('light-button') as HTMLButtonElement;
	const indicator = document.getElementById('menu-indicator') as HTMLElement;

	fetch('https://gist.githubusercontent.com/Lenochxd/12a1927943a2ce151560e1b9585d4bfa/raw/41d5a0dc9336827cefb217c1728f0e9415b1c7b9/colors_db.json')
		.then(response => response.json())
		.then(data => {
			colors = data;
			displayColors(colors);
			colorCount.innerText = `${colors.length} colors available`;
			moveIndicator(indicator, allBtn);
		})
		.catch(error => {
			console.error('Error fetching the colors:', error);
			colorCount.innerText = 'Error loading colors';
		});

	function displayColors(colorArray: any[]) {
		if (!container) return;
		container.innerHTML = '';
		
		const staggerDelay = colorArray.length > 100 ? 5 : 15;

		colorArray.forEach((color, index) => {
			const colorBox = document.createElement('div');
			colorBox.className = 'color-box';
			const r = parseInt(color.hex_code.slice(1, 3), 16);
			const g = parseInt(color.hex_code.slice(3, 5), 16);
			const b = parseInt(color.hex_code.slice(5, 7), 16);
			colorBox.style.setProperty('--card-rgb', `${r}, ${g}, ${b}`);
			colorBox.style.backgroundColor = color.hex_code;
			colorBox.style.animationDelay = `${index * staggerDelay}ms`;
			colorBox.setAttribute('data-hex', color.hex_code);

			const textColor = isDarkColor(color.hex_code) ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.9)';
			colorBox.style.color = textColor;

			colorBox.innerHTML = `
				<div class="color-box-content">
					<div class="color-info">
						<span class="color-name">${color.name}</span>
						<span class="color-hex">${color.hex_code}</span>
					</div>
				</div>
			`;

			colorBox.onclick = () => {
				navigator.clipboard.writeText(color.hex_code).then(() => {
					const event = new CustomEvent('color-copied', {
						detail: {
							color: color.hex_code,
							element: colorBox,
							message: 'Copied HEX!'
						}
					});
					document.dispatchEvent(event);
				}).catch(err => {
					console.error('Failed to copy color code: ', err);
				});
			};
			container.appendChild(colorBox);
		});
	}

	function moveIndicator(targetIndicator: HTMLElement | null, btn: HTMLElement | null) {
		if (!targetIndicator || !btn) return;
		targetIndicator.style.width = `${btn.offsetWidth}px`;
		targetIndicator.style.transform = `translateX(${btn.offsetLeft - 2}px)`;
	}

	async function filterColors(type: 'all' | 'dark' | 'light') {
		if (!container) return;

		container.classList.add('filtering');
		await new Promise(resolve => setTimeout(resolve, 300));

		let filteredColors: any[];
		if (type === 'dark') {
			filteredColors = colors.filter(color => isDarkColor(color.hex_code));
		} else if (type === 'light') {
			filteredColors = colors.filter(color => !isDarkColor(color.hex_code));
		} else {
			filteredColors = colors;
		}
		
		displayColors(filteredColors);
		if (colorCount) colorCount.innerText = `${filteredColors.length} colors available`;

		container.classList.remove('filtering');

		const activeBtn = document.getElementById(`${type}-button`) as HTMLButtonElement;
		[allBtn, darkBtn, lightBtn].forEach(btn => btn.classList.remove('active'));
		if (activeBtn) {
			activeBtn.classList.add('active');
			moveIndicator(indicator, activeBtn);
		}
	}

	const gridCompact = document.getElementById('grid-compact') as HTMLButtonElement;
	const gridComfortable = document.getElementById('grid-comfortable') as HTMLButtonElement;
	const gridLarge = document.getElementById('grid-large') as HTMLButtonElement;
	const gridIndicator = document.getElementById('grid-indicator') as HTMLElement;

	async function setGridSize(size: 'compact' | 'comfortable' | 'large') {
		if (!container) return;
		
		container.classList.add('filtering');
		await new Promise(resolve => setTimeout(resolve, 300));

		container.classList.remove('compact', 'large');
		if (size !== 'comfortable') {
			container.classList.add(size);
		}

		const currentFilter = (document.querySelector('.menu button.active') as HTMLElement)?.id.split('-')[0] as 'all' | 'dark' | 'light';
		
		let filteredColors: any[];
		if (currentFilter === 'dark') {
			filteredColors = colors.filter(color => isDarkColor(color.hex_code));
		} else if (currentFilter === 'light') {
			filteredColors = colors.filter(color => !isDarkColor(color.hex_code));
		} else {
			filteredColors = colors;
		}
		
		displayColors(filteredColors);

		const activeBtn = document.getElementById(`grid-${size}`) as HTMLButtonElement;
		[gridCompact, gridComfortable, gridLarge].forEach(btn => btn?.classList.remove('active'));
		if (activeBtn) {
			activeBtn.classList.add('active');
			moveIndicator(gridIndicator, activeBtn);
		}

		container.classList.remove('filtering');
	}

	window.addEventListener('load', () => {
		const initIndicators = () => {
			moveIndicator(indicator, allBtn);
			moveIndicator(gridIndicator, gridComfortable);
		};
		initIndicators();
		document.fonts.ready.then(initIndicators);
		setTimeout(initIndicators, 100);
	});

	window.addEventListener('resize', () => {
		const activeMenuBtn = document.querySelector('.menu button.active') as HTMLElement;
		const activeGridBtn = document.querySelector('.grid-controls button.active') as HTMLElement;
		moveIndicator(indicator, activeMenuBtn);
		moveIndicator(gridIndicator, activeGridBtn);
	});

	gridCompact?.addEventListener('click', () => setGridSize('compact'));
	gridComfortable?.addEventListener('click', () => setGridSize('comfortable'));
	gridLarge?.addEventListener('click', () => setGridSize('large'));

	allBtn?.addEventListener('click', () => filterColors('all'));
	darkBtn?.addEventListener('click', () => filterColors('dark'));
	lightBtn?.addEventListener('click', () => filterColors('light'));

	const toggleGap = document.getElementById('toggle-gap') as HTMLButtonElement;
	const toggleInfo = document.getElementById('toggle-info') as HTMLButtonElement;

	toggleGap?.addEventListener('click', () => {
		const isActive = toggleGap.classList.contains('active');
		if (isActive) {
			toggleGap.classList.remove('active');
			container.classList.add('no-gap');
		} else {
			toggleGap.classList.add('active');
			container.classList.remove('no-gap');
		}
	});

	toggleInfo?.addEventListener('click', () => {
		const isActive = toggleInfo.classList.contains('active');
		if (isActive) {
			toggleInfo.classList.remove('active');
			container.classList.remove('show-info');
		} else {
			toggleInfo.classList.add('active');
			container.classList.add('show-info');
		}
	});

	// Keyboard shortcut for grid gap (Space)
	document.addEventListener('keydown', (e) => {
		if (e.code === 'Space') {
			e.preventDefault(); // Prevent scroll
			toggleGap?.click();
		}
	});
</script>
