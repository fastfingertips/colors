---
import Layout from '../layouts/Layout.astro';
import ScrollToTop from '../components/ScrollToTop.astro';
import FilterMenu from '../components/FilterMenu.astro';
import Footer from '../components/Footer.astro';
import GridControls from '../components/GridControls.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
---

<Layout title="Color List - Colors">
	<Breadcrumbs items={[{ label: 'List', active: true }]} />
	<main>
		<div class="header">
			<h1>Colors</h1>
			<div class="header-desc">
				<span class="desc-item">
					<span class="key-badge icon" title="Left Click">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="6" y="2" width="12" height="20" rx="4"></rect>
							<line x1="12" y1="2" x2="12" y2="10"></line>
							<line x1="6" y1="10" x2="18" y2="10"></line>
							<path d="M6 6a4 4 0 0 1 4-4h2v8H6V6z" fill="currentColor"></path>
						</svg>
					</span> 
					<span class="action-text">to copy</span>
				</span>
				<span class="desc-separator">&middot;</span>
				<span class="desc-item">
					<span class="key-badge icon" title="Right Click">
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<rect x="6" y="2" width="12" height="20" rx="4"></rect>
							<line x1="12" y1="2" x2="12" y2="10"></line>
							<line x1="6" y1="10" x2="18" y2="10"></line>
							<path d="M12 2h2a4 4 0 0 1 4 4v4h-6V2z" fill="currentColor"></path>
						</svg>
					</span> 
					<span class="action-text">for menu</span>
				</span>
				<span class="desc-separator">&middot;</span>
				<span class="desc-item">
					<span class="key-badge icon" title="Spacebar">
						<svg width="24" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 5H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"></path>
							<path d="M8 11h8" stroke-width="2"></path>
							<path d="M20 9v2" stroke-width="1"></path>
							<path d="M4 9v2" stroke-width="1"></path>
						</svg>
					</span> 
					<span class="action-text">toggle view</span>
				</span>
			</div>
		</div>

		<div class="controls-container">
			<FilterMenu />
			<span id="color-count">...</span>
			<GridControls />
		</div>

		<div id="color-container" class="color-container show-info no-gap"></div>

		<div class="list-attribution">
			<p>Dedicated to <a href="https://github.com/Lenochxd" target="_blank">Lenoch</a></p>
			<p>Data provided by <a href="https://gist.githubusercontent.com/Lenochxd/12a1927943a2ce151560e1b9585d4bfa/raw/41d5a0dc9336827cefb217c1728f0e9415b1c7b9/colors_db.json" target="_blank">colors_db.json</a></p>
		</div>

		<Footer />
		
		<ScrollToTop />
	</main>
</Layout>

	import { isDarkColor } from '../utils/colorUtils';

	// State Management
	const state = {
		colors: [] as any[],
		filter: 'all' as 'all' | 'dark' | 'light',
		gridSize: 'comfortable' as 'compact' | 'comfortable' | 'large'
	};

	// DOM Elements
	const container = document.getElementById('color-container') as HTMLElement;
	const colorCount = document.getElementById('color-count') as HTMLElement;
	const filterIndicator = document.getElementById('menu-indicator') as HTMLElement;
	const gridIndicator = document.getElementById('grid-indicator') as HTMLElement;
	
	// Buttons
	const filterBtns = {
		all: document.getElementById('all-button') as HTMLButtonElement,
		dark: document.getElementById('dark-button') as HTMLButtonElement,
		light: document.getElementById('light-button') as HTMLButtonElement
	};

	const gridBtns = {
		compact: document.getElementById('grid-compact') as HTMLButtonElement,
		comfortable: document.getElementById('grid-comfortable') as HTMLButtonElement,
		large: document.getElementById('grid-large') as HTMLButtonElement
	};

	const toggleGap = document.getElementById('toggle-gap') as HTMLButtonElement;
	const toggleInfo = document.getElementById('toggle-info') as HTMLButtonElement;

	// Initialize
	function init() {
		colorCount.innerHTML = '<span class="loading-pulse">Loading colors...</span>';
		container.innerHTML = '<div class="spinner-container"><div class="spinner"></div></div>';

		fetch('https://gist.githubusercontent.com/Lenochxd/12a1927943a2ce151560e1b9585d4bfa/raw/41d5a0dc9336827cefb217c1728f0e9415b1c7b9/colors_db.json')
			.then(response => response.json())
			.then(data => {
				state.colors = data;
				renderColors();
				updateUI();
			})
			.catch(error => {
				console.error('Error fetching colors:', error);
				colorCount.innerHTML = '<span style="color: #ff3b30">Error loading colors</span>';
			});

		setupEventListeners();
	}

	function setupEventListeners() {
		// Filter Buttons
		Object.entries(filterBtns).forEach(([key, btn]) => {
			btn?.addEventListener('click', () => {
				if (state.filter === key) return;
				state.filter = key as any;
				updateUI();
				filterColors();
			});
		});

		// Grid Buttons
		Object.entries(gridBtns).forEach(([key, btn]) => {
			btn?.addEventListener('click', () => {
				if (state.gridSize === key) return;
				state.gridSize = key as any;
				updateUI();
			});
		});

		// Toggles
		toggleGap?.addEventListener('click', () => {
			toggleGap.classList.toggle('active');
			container.classList.toggle('no-gap');
		});

		toggleInfo?.addEventListener('click', () => {
			toggleInfo.classList.toggle('active');
			container.classList.toggle('show-info');
		});

		// Window Events
		window.addEventListener('resize', updateIndicators);
		document.addEventListener('keydown', (e) => {
			if (e.code === 'Space') {
				e.preventDefault();
				toggleGap?.click();
			}
		});
	}

	function updateUI() {
		// Update Filter Buttons
		Object.values(filterBtns).forEach(btn => btn?.classList.remove('active'));
		filterBtns[state.filter]?.classList.add('active');

		// Update Grid Buttons
		Object.values(gridBtns).forEach(btn => btn?.classList.remove('active'));
		gridBtns[state.gridSize]?.classList.add('active');

		// Update Container Classes
		container.classList.remove('compact', 'comfortable', 'large');
		if (state.gridSize !== 'comfortable') {
			container.classList.add(state.gridSize);
		}

		updateIndicators();
	}

	function updateIndicators() {
		const activeFilterBtn = filterBtns[state.filter];
		const activeGridBtn = gridBtns[state.gridSize];

		if (activeFilterBtn && filterIndicator) {
			filterIndicator.style.width = `${activeFilterBtn.offsetWidth}px`;
			filterIndicator.style.transform = `translateX(${activeFilterBtn.offsetLeft - 2}px)`;
		}

		if (activeGridBtn && gridIndicator) {
			gridIndicator.style.width = `${activeGridBtn.offsetWidth}px`;
			gridIndicator.style.transform = `translateX(${activeGridBtn.offsetLeft}px)`; // Adjusted offset
		}
	}

	function renderColors() {
		container.innerHTML = '';
		const staggerDelay = state.colors.length > 100 ? 5 : 15;

		state.colors.forEach((color, index) => {
			const colorBox = document.createElement('div');
			colorBox.className = 'color-box';
			
			// Pre-calculate values
			const isDark = isDarkColor(color.hex_code);
			const r = parseInt(color.hex_code.slice(1, 3), 16);
			const g = parseInt(color.hex_code.slice(3, 5), 16);
			const b = parseInt(color.hex_code.slice(5, 7), 16);

			// Set properties
			colorBox.style.setProperty('--card-rgb', `${r}, ${g}, ${b}`);
			colorBox.style.backgroundColor = color.hex_code;
			colorBox.style.animationDelay = `${index * staggerDelay}ms`;
			colorBox.style.color = isDark ? 'rgba(255,255,255,0.9)' : 'rgba(0,0,0,0.9)';
			
			// Data attributes for filtering
			colorBox.dataset.hex = color.hex_code;
			colorBox.dataset.brightness = isDark ? 'dark' : 'light';

			colorBox.innerHTML = `
				<div class="color-box-content">
					<div class="color-info">
						<span class="color-name">${color.name}</span>
						<span class="color-hex">${color.hex_code}</span>
					</div>
				</div>
			`;

			colorBox.onclick = () => {
				const pureHex = color.hex_code.substring(1);
				window.location.href = `/color/${pureHex}`;
			};

			container.appendChild(colorBox);
		});

		// Initial filter application
		filterColors();
	}

	async function filterColors() {
		if (!container) return;

		container.classList.add('filtering');
		
		// Small delay for animation
		await new Promise(resolve => setTimeout(resolve, 300));

		const boxes = container.querySelectorAll('.color-box');
		let visibleCount = 0;

		boxes.forEach((box: any) => {
			const brightness = box.dataset.brightness;
			const shouldShow = state.filter === 'all' || state.filter === brightness;

			if (shouldShow) {
				box.style.display = '';
				// Reset animation to play it again
				box.style.animation = 'none';
				box.offsetHeight; /* trigger reflow */
				box.style.animation = ''; 
				visibleCount++;
			} else {
				box.style.display = 'none';
			}
		});

		colorCount.innerText = `${visibleCount} colors available`;
		container.classList.remove('filtering');
	}

	// Start
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', init);
	} else {
		init();
	}
